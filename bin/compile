#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

# debug
# set -x

# clean up leaking environment
unset GIT_DIR

# config
PGBOUNCER_VERSION="1.5.4"
STUNNEL_VERSION="4.56"
S3_BUCKET="gregburek-buildpack-pgbouncer"

# parse and derive params
BUILD_DIR=$1
CACHE_DIR=$2
LP_DIR=`cd $(dirname $0); cd ..; pwd`

function error() {
  echo " !     $*" >&2
  exit 1
}

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

function package_download() {
  engine="$1"
  version="$2"
  location="$3"

  mkdir -p $location
  package="http://${S3_BUCKET}.s3.amazonaws.com/$engine-$version.tgz"
  curl $package -s -o - | tar xzf - -C $location
}

echo "Using pgbouncer version: ${PGBOUNCER_VERSION}" | indent

echo "Using stunnel version: ${STUNNEL_VERSION}" | indent

# s3 packages
PGBOUNCER_PACKAGE="http://${S3_BUCKET}.s3.amazonaws.com/pgbouncer-${PGBOUNCER_VERSION}.tgz"
STUNNEL_PACKAGE="http://${S3_BUCKET}.s3.amazonaws.com/stunnel-${STUNNEL_VERSION}.tgz"

# vendor directories
VENDORED_PGBOUNCER="vendor/pgbouncer"
VENDORED_STUNNEL="vendor/stunnel"

# vendor pgbouncer into the slug
PATH="$BUILD_DIR/$VENDORED_PGBOUNCER/bin:$PATH"
echo "-----> Fetching and vendoring pgbouncer into slug"
mkdir -p "$BUILD_DIR/$VENDORED_PGBOUNCER"
package_download "pgbouncer" "${PGBOUNCER_VERSION}" "${BUILD_DIR}/${VENDORED_PGBOUNCER}"

# vendor stunnel into the slug
PATH="$BUILD_DIR/$VENDORED_STUNNEL/bin:$PATH"
echo "-----> Fetching and vendoring stunnel into slug"
mkdir -p "$BUILD_DIR/$VENDORED_STUNNEL"
package_download "stunnel" "${STUNNEL_VERSION}" "${BUILD_DIR}/${VENDORED_STUNNEL}"

echo "-----> Generating the configuration generation script"
mkdir -p $BUILD_DIR/.profile.d
cat >>$BUILD_DIR/.profile.d/generate-conf.sh <<'EOF'
#!/usr/bin/env bash

DB=$(echo $DATABASE_URL | perl -lne 'print "$1 $2 $3 $4 $5 $6 $7" if /^postgres:\/\/([^:]+):([^@]+)@(.*?):(.*?)\/(.*?)(\\?.*)?$/')
DB_URI=( $DB )
USER=${DB_URI[0]}
PASS=${DB_URI[1]}
HOST=${DB_URI[2]}
PORT=${DB_URI[3]}
DBNAME=${DB_URI[4]}

export PGBOUNCER_URI=${PGBOUNCER_URI:127.0.0.1:6000/$DBNAME }

cat >> /app/vendor/stunnel/stunnel-pgbouncer.conf << EOFEOF
chroot = /app/vendor/stunnel/var/lib/stunnel/
setuid = nobody
setgid = nogroup
pid = /stunnel.pid
foreground = yes

options = NO_SSLv2
options = SINGLE_ECDH_USE
options = SINGLE_DH_USE
socket = r:TCP_NODELAY=1
options = NO_SSLv3
ciphers = HIGH:!ADH:!AECDH:!LOW:!EXP:!MD5:!3DES:!SRP:!PSK:@STRENGTH

[heroku-postgres]
client=yes
accept  = 127.0.0.1:6002
connect = $HOST:$PORT
retry = yes

EOFEOF

cat >> /app/vendor/pgbouncer/pgbouncer.ini << EOFEOF
[databases]
heroku_postgres = host=127.0.0.1 port=6002 dbname=$DBNAME user=$USER password=$PASS
[pgbouncer]
listen_addr = 127.0.0.1
listen_port = 6000
auth_type = any

; When server connection is released back to pool:
;   session      - after client disconnects
;   transaction  - after transaction finishes
;   statement    - after statement finishes
pool_mode = session
server_reset_query = DISCARD ALL
max_client_conn = 100
default_pool_size = 20

EOFEOF
EOF
chmod +x $BUILD_DIR/.profile.d/generate-conf.sh

echo "-----> Generating the startup script"
cat >>$BUILD_DIR/bin/pgbouncer-stunnel.sh <<EOF
#!/usr/bin/env bash
$VENDORED_STUNNEL/bin/stunnel $VENDORED_STUNNEL/stunnel-pgbouncer.conf
$VENDORED_PGBOUNCER/bin/pgbouncer $VENDORED_PGBOUNCER/pgbouncer.ini
EOF
chmod +x $BUILD_DIR/bin/pgbouncer-stunnel.sh

echo "-----> pgbouncer/stunnel done"
